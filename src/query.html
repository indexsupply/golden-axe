<!doctype html>
<html>
    <head>
        <link
            rel="icon"
            href="https://indexsupply.net/ga.ico"
            type="image/x-icon"
        />
        <meta charset="utf-8" />
        <title>Golden Axe</title>
        <style>
            body {
                font-family: system-ui;
                max-width: 800px;
                margin: 0 auto;
            }
            .header {
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .header h1 a {
                color: #000000;
                text-decoration: none;
            }
            .header img {
                height: 30px;
            }
            #request {
                width: 100%;
                padding-bottom: 10px;
            }
            #events {
                width: 99%;
                height: 100px;
                font-size: large;
                font-family: monospace;
            }
            #query {
                width: 99%;
                height: 300px;
                font-size: large;
                font-family: monospace;
            }
            #live-query {
                padding-bottom: 1px;
            }
            #request input[type="submit"] {
                float: right;
                width: 10%;
            }
            #stats {
                display: none;
                width: 100%;
                padding-top: 5px;
                padding-bottom: 10px;
                border-top: 1px dotted gray;
            }
            #block-height {
                font-size: medium;
                margin-left: auto;
                font-family: monospace;
                padding-right: 10px;
            }
            #response {
                width: 100%;
                overflow-x: auto;
                font-family: monospace;
                font-size: medium;
                margin-top: 5px;
            }
            #response table {
                width: 100%;
            }
            th {
                font-size: medium;
                padding-bottom: 5px;
                text-align: left;
            }
            #response td {
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .highlight {
                background-color: lightyellow;
                transition: background-color 0.25s ease-in-out;
            }
            .error {
                padding: 20px;
                font-size: x-large;
                color: #eb2d3a;
            }
            .info {
                padding: 20px;
                font-size: x-large;
                color: #000000;
            }
        </style>
    </head>
    <body>
        <main>
            <div class="header">
                <img src="https://indexsupply.net/ga.png" />
                <h1>Golden Axe</h1>
            </div>
            <form action="/query" id="request" method="POST">
                <textarea
                    id="events"
                    type="text"
                    placeholder="Event Signatures"
                >
Transfer(address indexed from, address indexed to, uint tokens)</textarea
                >
                <textarea
                    id="query"
                    type="text"
                    placeholder="SQL Query"
                    autofocus
                >
select block_num, tx_hash, "from", "to", tokens from transfer limit 5
                </textarea>
                <input type="submit" value="Submit" />
                <label for="live-query"> Live Query</label>
                <input type="checkbox" id="live-query" checked />
            </form>
            <div id="stats">
                <span>Last Block:</span>
                <span id="block-height"></span>
                <span>Num Rows:</span>
                <span id="num-rows"></span>
            </div>
            <div id="response"></div>
        </main>
    </body>
    <script>
        function encodeForm(form) {
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value.trim());
            }
            return params.toString();
        }

        function addHeaderRow(row) {
            const table = document.querySelector("#response table");
            let tr = table.insertRow(0);
            row.forEach((col, i) => {
                const th = document.createElement("th");
                th.textContent = col;
                tr.appendChild(th);
            });
        }

        function addDataRow(rows) {
            const table = document.querySelector("#response table");
            rows.forEach((row) => {
                let tr = table.insertRow(1);
                row.forEach((col, i) => {
                    let td = tr.insertCell(i);
                    td.textContent = col;
                });
                tr.classList.add("highlight");
                setTimeout(() => {
                    tr.classList.remove("highlight");
                }, 500);
            });
            while (table.rows.length > 100) {
                table.deleteRow(-1);
            }
        }

        function printInfo(msg) {
            const response = document.getElementById("response");
            const p = document.createElement("p");
            p.classList.add("info");
            p.textContent = msg;
            response.appendChild(p);
        }

        function printError(msg) {
            const response = document.getElementById("response");
            const p = document.createElement("p");
            p.classList.add("error");
            p.textContent = msg;
            response.appendChild(p);
        }

        function resetTable() {
            const response = document.getElementById("response");
            const table = document.createElement("table");
            response.innerHTML = "";
            response.appendChild(table);
        }

        let sseHandler = {};
        function startHandler(height, eventSigs, query) {
            if (!liveQueryEnabled()) {
                return;
            }
            const params = new URLSearchParams();
            params.append("block_height", height);
            params.append("query", query);
            eventSigs.forEach((sig) => {
                params.append("event_signatures", sig);
            });
            let queryParams = params.toString();
            sseHandler = new EventSource(`/query-live?${queryParams}`);
            sseHandler.onmessage = function (event) {
                let data = JSON.parse(event.data);
                let newHeight = data["block_height"];
                let result = data["result"][0];
                if (newHeight <= blockHeight) {
                    return;
                }
                result.shift(); //remove column names
                updateStats(newHeight, result.length);
                addDataRow(result);
            };
            sseHandler.onerror = function (e) {
                console.log(e);
            };
        }

        function closeHandler() {
            if ("close" in sseHandler) {
                sseHandler.close();
            }
        }

        function getEventSigs() {
            return document.getElementById("events").value.split("\n");
        }

        function getQuery() {
            return document.getElementById("query").value;
        }

        let blockHeight = 0;
        function updateStats(height, nrows) {
            document.getElementById("stats").style.display = "block";
            blockHeight = height;
            document.querySelector("#block-height").textContent = height;
            document.querySelector("#num-rows").textContent = nrows;
        }

        async function submitQuery(event) {
            event.preventDefault();
            closeHandler();
            const eventSigs = getEventSigs();
            const query = getQuery();
            const response = await fetch("/query", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify([
                    { event_signatures: eventSigs, query: query },
                ]),
            });
            if (!response.ok) {
                const { message } = await response.json();
                resetTable();
                printError(message);
            } else {
                const data = await response.json();
                let height = data["block_height"];
                let result = data["result"][0];
                if (result.length > 0) {
                    resetTable();
                    addHeaderRow(result.shift());
                    updateStats(height, result.length);
                    addDataRow(result);
                    startHandler(height + 1, eventSigs, query);
                } else {
                    resetTable();
                    printInfo("no rows");
                }
            }
        }

        function cmdEnter(event) {
            if (event.keyCode == 13 && event.metaKey) {
                let query = document.getElementById("query");
                query.value = query.value.trim();
                document.getElementById("request").dispatchEvent(
                    new Event("submit", {
                        bubbles: true,
                        cancelable: true,
                    }),
                );
            }
        }

        function liveQueryEnabled() {
            return document.getElementById("live-query").checked;
        }

        function changeLiveQuery(event) {
            closeHandler();
            if (event.target.checked) {
                startHandler(blockHeight + 1, getEventSigs(), getQuery());
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            document
                .getElementById("query")
                .addEventListener("keydown", cmdEnter);
            document
                .getElementById("request")
                .addEventListener("submit", submitQuery);
            document
                .getElementById("live-query")
                .addEventListener("change", changeLiveQuery);
        });
    </script>
</html>
