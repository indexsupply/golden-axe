<!doctype html>
    <head>
        <link
            rel="icon"
            href="https://indexsupply.net/ga.png"
            type="image/x-icon"
        />
        <meta charset="utf-8" />
        <title>Index Supply / Account</title>
        <style>
        body {
            font-family: system, sans-serif;
            font-size: 0.95em;
            letter-spacing: -0.005em;
            line-height: 1.58;

            max-width: 800px;
            margin: 0 auto;
        }
        a:link,
        a:visited,
        a:hover,
        a:active {
            color: blue;
            text-decoration: none;
        }
        .navigation {
            width: 100%;
            padding: 10px;
            font-size: large;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            height: 30px;
        }
        .Success {
            color: green;
        }
        .Error {
            color: red;
        }
        #api-keys {
            width: 100%;
        }
        .api-key {
            width: 100%;
            display: flex;
            flex-direction: row;
        }
        .api-key:last-of-type {
            border-bottom: 1px solid black;
        }
        .api-key .header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .api-key .secret {
            font-family: monospace;
            width: 40%;
            white-space: nowrap;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .api-key .origins {
            text-align: left;
            width: 30%;
            white-space: nowrap;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .api-key .created_at {
            text-align: left;
            width: 20%;
        }
        .api-key .delete {
            text-align: right;
            width: 10%;
        }
        #new-api-key {
            padding: 10px 0 0 0;
            text-align: right;
        }
        .plan {
            width: 100%;
        }
        .plan h3 {
            margin: 0px 0 5px 0;
            font-weight: normal;
            text-transform: capitalize;
        }
        .menu {
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
            flex-grow: 1;
            gap: 20px;
            margin-bottom: 10px;
        }
        .menu h4 {
            font-size: large;
            font-weight: normal;
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid black;
        }
        .option.selected {
            border: 2px solid green;
        }
        .option {
            width: 100%;
            box-sizing: border-box;
            border: 2px inset black;
            padding: 0 0 10px 0;
            min-height: 350px;
        }
        .option ul {
            padding-inline-start: 20px;
        }
        .option li {
            padding-left: 0px;
        }
        .option p {
            padding-left: 5px;
        }
        .option form {
            padding-left: 5px;
        }
        .option p.price span {
            padding-left: 5px;
            font-size: x-small;
        }
        .hidden {
            visibility: hidden;
        }
        .opaque {
            opacity: 10%;
        }
        .highlight {
            background-color: lightyellow;
        }
        </style>
    </head>
    <body>
        <div class="navigation">
            <div>
                {{#each flash }}
                <marquee class="{{level}}">{{ message }}</marquee>
                {{/each}}
            </div>
            <div>
                <a href="/docs">Docs</a>,
                <a href="https://www.indexsupply.net/status">Status</a>,
                <a href="/">Query</a>,
                <a href="/logout">Log Out</a>,
            </div>
        </div>
        <div id="api-keys">
            <h2>API Keys</h2>
            <div id="keys">
            {{#if (gt (len api_keys) 0)}}
            <div class="api-key header">
                <div class="secret header"><span>key</span></div>
                <div class="origins header"><span>origins</span></div>
                <div class="created_at header"><span>created_at</span></div>
            </div>
            {{else}}
            <span>No API Keys</span>
            {{/if}}
            {{#each api_keys }}
            <div class="api-key">
                <div class="secret"><span>{{ secret }}</span></div>
                <div class="origins"><span>{{ (join origins ",") }}</span></div>
                <div class="created_at"><span></span>{{ created_at }}</span></div>
                <div class="delete"><a href="{{ secret }}">delete</a></div>
            </div>
            {{/each}}
            </div>
            <div id="new-api-key">
                <a href="/new-api-key">new api key</a>
            </div>
        </div>
        <div class="plan">
            <h2>Plan</h2>
            <h3>
            {{#if plan}}
            Current Plan: {{plan.name}}
            {{/if}}
            {{#if plan.expiration }}
                <br><span>Service Until: {{plan.expiration}}</span>
            {{/if}}
            {{#if plan.stripe_session }}
                <br><span>Charged {{(money plan.amount)}} monthly via Stripe</span>
            {{/if}}
            </h3>
            <div class="menu">
                {{#each options }}
                <div class="option" name="{{this.name}}">
                    <h4>{{ name }}</h4>
                    <ul>{{#each features}}<li>{{ this }}</li>{{/each}}</ul>
                    {{#if show_purchase_button }}
                    <p class="price">{{daimo_amount}} per year<span>({{daimo_monthly}} per month)</span></p>
                    <form action="/setup-daimo" method="POST">
                        <input type="hidden" name="plan_name" value="{{this.name}}">
                        <button type="submit">Pay with Crypto</button>
                    </form>
                    <p>{{stripe_amount}} per month</p>
                    <form action="/setup-stripe" method="POST">
                        <input type="hidden" name="plan_name" value="{{this.name}}">
                        <button type="submit">Pay with Card</button>
                    </form>
                    {{/if}}
                </div>
                {{/each}}
            </div>
        </div>
        <div id="card">
            <form action="/update-stripe" method="POST">
                <button type="submit">Update Card</button>
            </form>
        </div>
    </body>

    <script defer>

      function deleteApiKey(event) {
        event.preventDefault();
        const secret = this.getAttribute('href');
        if (!confirm(`delete api key: ${secret.substring(0,4)}...?`)) {
          return;
        }
        fetch("/delete-api-key", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(secret),
        }).then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            response.text().then(msg => {
              document.getElementById("error").textContent = msg;
            });
          }
        })
      };

      document.addEventListener("DOMContentLoaded", () => {
        {{#if plan}}
        document.querySelector(`div.option[name="{{plan.name}}"]`).classList.add("selected");
        {{/if}}

        document.querySelectorAll(".api-key:not(.header)").forEach(div => {
          div.addEventListener("mouseover", event => {
            div.classList.add("highlight");
          });
          div.addEventListener("mouseout", event => {
            div.classList.remove("highlight");
          });
        });

        document.querySelectorAll(".api-key .delete a").forEach(div => {
          div.addEventListener("click", deleteApiKey);
        });

        setTimeout(() => {
          document.querySelectorAll('marquee').forEach(el => {
            el.style.display = 'none';
          });
        }, 10000);
      });
    </script>
</html>
