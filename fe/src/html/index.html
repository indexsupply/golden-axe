<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Index Supply / SQL API</title>
        <style>
            body {
                font-family: Times New Roman;
                max-width: 800px;
                margin: 0 auto;
            }
            a:link,
            a:visited,
            a:hover,
            a:active {
                color: blue;
                text-decoration: none;
            }
            .navigation {
                padding-top: 5px;
                font-size: large;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                height: 30px;
            }
            .navigation .Success {
                color: green;
            }
            .navigation .Error {
                color: red;
            }
            .header {
                width: 100%;
                margin: 0 0 20px 0;
            }
            .header h1 {
                width: 100%;
                font-size: 5.2em;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
                letter-spacing: -3px;
                margin: 5px 0 0 0;
            }
            .header img {
                position: fixed;
                top: 0;
                left: 0;
                width: 30px;
            }
            .header h1 a {
                color: #000000;
                text-decoration: none;
            }
            #request {
                width: 100%;
                padding-bottom: 10px;
            }
            #events {
                width: 99%;
                height: 100px;
                font-size: large;
                font-family: monospace;
            }
            #query {
                width: 99%;
                height: 300px;
                font-size: large;
                font-family: monospace;
            }
            #query-options {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }
            .query-options-left {
                display: flex;
                flex-direction: row;
                gap: 20px;
            }
            .query-options-right {
                width: 10%;
            }
            .query-options-right input {
                width: 100%;
            }
            #live-query {
                padding-bottom: 1px;
            }
            #stats {
                display: none;
                width: 100%;
                padding-top: 5px;
                padding-bottom: 10px;
                border-top: 1px dotted gray;
            }
            #block-height {
                font-size: medium;
                margin-left: auto;
                font-family: monospace;
                padding-right: 10px;
            }
            #response {
                width: 100%;
                overflow-x: auto;
                font-family: monospace;
                font-size: medium;
                margin-top: 5px;
            }
            #response table {
                width: 100%;
            }
            th {
                font-size: medium;
                padding-bottom: 5px;
                text-align: left;
            }
            #response td {
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .highlight {
                background-color: lightyellow;
                transition: background-color 0.25s ease-in-out;
            }
            .error {
                padding: 20px;
                font-size: x-large;
                color: #eb2d3a;
            }
            .info {
                padding: 20px;
                font-size: x-large;
                color: #000000;
            }
        </style>
    </head>
    <body>
        <div class="navigation">
            <div>
                {{#each flash }}
                <marquee class="{{level}}">{{ message }}</marquee>
                {{/each}}
            </div>
            <div>
                <a href="/docs">docs</a>, {{#with user}}
                <a href="/account">account</a>
                {{else}}
                <a href="/login">log in</a>
                {{/with}}
            </div>
        </div>
        <div class="header">
            <img src="https://indexsupply.net/beta.png" />
            <h1>Index Supply / SQL API</h1>
        </div>
        <main>
            <form action="/query" id="request" method="POST">
                <textarea
                    id="events"
                    type="text"
                    placeholder="Event Signatures"
                >
Transfer(address indexed from, address indexed to, uint tokens)</textarea
                >
                <textarea
                    id="query"
                    type="text"
                    placeholder="SQL Query"
                    autofocus
                >
select block_num, tx_hash, "from", "to", tokens from transfer limit 5</textarea
                >
                <div id="query-options">
                    <div class="query-options-left">
                        <div>
                            <label for="live-query">Live Query</label>
                            <input type="checkbox" id="live-query" checked />
                        </div>
                        <div>
                            <label for="chain-selection">Chain</label>
                            <select id="chain-selection">
                                <option value="8543">Base</option>
                                <option value="85432">Base Sepolia</option>
                            </select>
                        </div>
                    </div>
                    <div class="query-options-right">
                        <div><input type="submit" value="Submit" /></div>
                    </div>
                </div>
            </form>
            <div id="stats">
                <span>Last Block:</span>
                <span id="block-height"></span>
                <span>Num Rows:</span>
                <span id="num-rows"></span>
            </div>
            <div id="response"></div>
        </main>
    </body>
    <script>
        function addHeaderRow(row) {
            const table = document.querySelector("#response table");
            let tr = table.insertRow(0);
            row.forEach((col, i) => {
                const th = document.createElement("th");
                th.textContent = col;
                tr.appendChild(th);
            });
        }

        function addDataRow(rows) {
            let table = document.querySelector("#response table");
            rows.forEach((row) => {
                let tr = document.createElement("tr");
                row.forEach((col, i) => {
                    let td = document.createElement("td");
                    td.textContent = col;
                    tr.appendChild(td);
                });
                if (table.rows.length > 1) {
                    table.insertBefore(tr, table.rows[1]);
                } else {
                    table.appendChild(tr);
                }
                tr.classList.add("highlight");
                setTimeout(() => {
                    tr.classList.remove("highlight");
                }, 500);
            });
            while (table.rows.length > 100) {
                table.deleteRow(-1);
            }
        }

        function printInfo(msg) {
            const response = document.getElementById("response");
            const p = document.createElement("p");
            p.classList.add("info");
            p.textContent = msg;
            response.appendChild(p);
        }

        function printError(msg) {
            const response = document.getElementById("response");
            const p = document.createElement("p");
            p.classList.add("error");
            p.textContent = msg;
            response.appendChild(p);
        }

        function resetTable() {
            const response = document.getElementById("response");
            const table = document.createElement("table");
            response.innerHTML = "";
            response.appendChild(table);
        }

        let sseHandler = {};
        let blockHeight = 0;

        function apiURL(path, params = new URLSearchParams()) {
            let chain = document.getElementById("chain-selection").value;
            params.set("chain", chain);
            return `{{ api_url }}${path}?${params}`;
        }

        function updateStats(height, nrows) {
            document.getElementById("stats").style.display = "block";
            blockHeight = height;
            document.querySelector("#block-height").textContent = height;
            document.querySelector("#num-rows").textContent = nrows;
        }

        function changeLiveQuery(event) {
            closeHandler();
            if (event.target.checked) {
                startHandler(getEventSigs(), getQuery());
            }
        }

        function closeHandler() {
            if ("close" in sseHandler) {
                sseHandler.close();
            }
        }

        function startHandler() {
            function liveQueryEnabled() {
                return document.getElementById("live-query").checked;
            }
            if (!liveQueryEnabled()) {
                return;
            }
            console.log(`sse start: ${blockHeight}`);
            sseHandler = new EventSource(
                apiURL("/query-live", form2queryParams()),
            );
            sseHandler.onmessage = function (event) {
                let data = JSON.parse(event.data);
                let newHeight = data["block_height"];
                let result = data["result"][0];
                console.log(`sse latest: ${newHeight}`);
                if (newHeight <= blockHeight) {
                    console.log("sse nothing new");
                    return;
                }
                result.shift(); //remove column names
                addDataRow(result);
                updateStats(newHeight, result.length);
            };
            sseHandler.onerror = function (e) {
                console.log(`sse error: `, e);
            };
        }

        async function submitQuery(event) {
            event.preventDefault();
            closeHandler();
            form2url();
            const response = await fetch(apiURL("/query"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(form2JSON()),
            });
            if (!response.ok) {
                const { message } = await response.json();
                resetTable();
                printError(message);
            } else {
                const data = await response.json();
                let height = data["block_height"];
                let result = data["result"][0];
                if (result.length > 0) {
                    resetTable();
                    addHeaderRow(result.shift());
                    addDataRow(result);
                    updateStats(height, result.length);
                    startHandler();
                } else {
                    resetTable();
                    printInfo("no rows");
                }
            }
        }

        function cmdEnter(event) {
            if (event.keyCode == 13 && event.metaKey) {
                let query = document.getElementById("query");
                query.value = query.value.trim();
                document.getElementById("request").dispatchEvent(
                    new Event("submit", {
                        bubbles: true,
                        cancelable: true,
                    }),
                );
            }
        }

        function form2JSON() {
            let query = document.getElementById("query").value;
            let eventSigs = document.getElementById("events").value.split("\n");
            return [{ event_signatures: eventSigs, query: query }];
        }

        function form2queryParams() {
            let params = new URLSearchParams();
            let query = document.getElementById("query").value;
            params.append("query", query);
            let eventSigs = document.getElementById("events").value.split("\n");
            eventSigs.forEach((sig) => {
                params.append("event_signatures", sig);
            });
            let chain = document.getElementById("chain-selection").value;
            params.set("chain", chain);
            return params;
        }

        function form2url() {
            let url = new URL(window.location.href);
            url.pathname = "query";
            url.search = form2queryParams().toString();
            history.pushState(null, "", url);
            return url.searchParams.toString();
        }

        function setOrAddChain(chain) {
            let select = document.getElementById("chain-selection");
            Array.from(select.options).forEach((opt, i) => {
                if (opt.value === chain) {
                    select.selectedIndex = i;
                    return;
                }
            });
            let opt = document.createElement("option");
            opt.value = chain;
            opt.text = chain;
            select.add(opt);
            select.value = chain;
        }

        function url2form() {
            const params = new URLSearchParams(window.location.search);
            let query = params.get("query");
            if (query) {
                document.getElementById("query").value = query;
            }
            let eventSigs = params.getAll("event_signatures");
            if (eventSigs.length > 0) {
                document.getElementById("events").value = eventSigs.join("\n");
            }
            let chain = params.get("chain");
            if (chain) {
                setOrAddChain(chain);
            }
        }

        window.addEventListener("popstate", function (event) {
            url2form();
        });
        window.addEventListener("pushstate", function (event) {
            url2form();
        });

        document.addEventListener("DOMContentLoaded", function () {
            url2form();
            document
                .getElementById("query")
                .addEventListener("keydown", cmdEnter);
            document
                .getElementById("request")
                .addEventListener("submit", submitQuery);
            document
                .getElementById("live-query")
                .addEventListener("change", changeLiveQuery);
        });
    </script>
</html>
