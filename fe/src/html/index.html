<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Index Supply / SQL API</title>
        <style>
            body {
                font-family: Times New Roman;
                max-width: 800px;
                margin: 0 auto;
            }
            a:link,
            a:visited,
            a:hover,
            a:active {
                color: blue;
                text-decoration: none;
            }
            .navigation {
                width: 100%;
                padding: 10px;
                font-size: large;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                height: 30px;
            }
            .navigation .Success {
                color: green;
            }
            .navigation .Error {
                color: red;
            }
            .header {
                width: 100%;
                margin: 0 0 20px 0;
            }
            .header h1 {
                width: 100%;
                font-size: 5.2em;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
                letter-spacing: -3px;
                margin: 5px 0 0 0;
            }
            .header img {
                position: fixed;
                top: 0;
                left: 0;
                width: 30px;
            }
            .header h1 a {
                color: #000000;
                text-decoration: none;
            }
            #request {
                width: 100%;
            }
            #events {
                width: 99%;
                height: 100px;
                font-size: large;
                font-family: monospace;
            }
            #query {
                width: 99%;
                height: 300px;
                font-size: large;
                font-family: monospace;
            }
            #query-options {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                padding-bottom: 10px;
                border-bottom: 1px dotted gray;
            }
            .query-options-left {
                display: flex;
                flex-direction: row;
                align-items: baseline;
                gap: 20px;
            }
            .query-options-right {
                width: 10%;
            }
            .query-options-right input {
                width: 100%;
            }
            #live-query {
                padding-bottom: 1px;
            }
            #examples {
                width: 102%;
            }
            #history {
                display: none;
                width: 102%;
                overflow-y: scroll;
                scrollbar-width: thin;
                max-height: 400px;
            }
            .query {
                width: 98%;
                padding: 10px 0 10px 0;
                margin: 0 0 5px 0;
                display: flex;
                flex-direction: column;
                gap: 10px;
                border: 1px solid #E5E4E2;
            }
            .query:hover {
                cursor: pointer;
                background-color: lightyellow;
                transition: background-color 0.1s ease-in-out;
            }
            .query .timing {
                display: flex;
                flex-direction: row;
            }
            .query .desc {
                width: calc(100% - 5px);
                margin-left: 5px;
                font-size: large;
                font-weight: bold;
                width: 100%;
            }
            .query .latency {
                font-size: small;
                font-family: monospace;
                margin-right: 5px;
            }
            .query .created_at {
                width: calc(100% - 5px);
                margin-left: 5px;
                font-size: small;
                font-family: monospace;
                width: 100%;
            }
            .query .event {
                width: calc(100% - 10px);
                margin-left: 10px;
                font-family: monospace;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .query .sql {
                width: calc(100% - 10px);
                margin-left: 10px;
                font-family: monospace;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            #stats {
                display: none;
                width: 100%;
                padding-top: 5px;
                padding-bottom: 10px;
            }
            #block-height {
                font-size: medium;
                margin-left: auto;
                font-family: monospace;
                padding-right: 10px;
            }
            #response {
                width: 100%;
                overflow-x: auto;
                font-family: monospace;
                font-size: medium;
                margin-top: 5px;
            }
            #response table {
                width: 100%;
            }
            th {
                font-size: medium;
                padding-bottom: 5px;
                text-align: left;
            }
            #response td {
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .highlight {
                background-color: lightyellow;
                transition: background-color 0.25s ease-in-out;
            }
            .error {
                padding: 20px;
                font-size: x-large;
                color: #eb2d3a;
            }
            .info {
                padding: 20px;
                font-size: x-large;
                color: #000000;
            }
        </style>
    </head>
    <body>
        <div class="navigation">
            <div>
                {{#each flash }}
                <marquee class="{{level}}">{{ message }}</marquee>
                {{/each}}
            </div>
            <div>
                <a href="/docs">docs</a>, {{#with user}}
                <a href="/account">account</a>
                {{else}}
                <a href="/login">log in</a>
                {{/with}}
            </div>
        </div>
        <div class="header">
            <img src="https://indexsupply.net/beta.png" />
            <h1>Index Supply / SQL API</h1>
        </div>
        <main>
            <form action="/query" id="request" method="POST">
                <textarea id="events" type="text" placeholder="Event Signatures"></textarea>
                <textarea id="query" type="text" tabindex="1" placeholder="SQL Query"></textarea>
                <div id="query-options">
                    <div class="query-options-left">
                        <div>
                            <label for="live-query">Live Query</label>
                            <input type="checkbox" id="live-query" />
                        </div>
                        <div>
                            <label for="chain-selection">Chain</label>
                            <select id="chain-selection">
                                <option value="8453">Base</option>
                                <option value="84532">Base Sepolia</option>
                                <option value="1">Main</option>
                                <option value="911867">Odyssey</option>
                                <option value="4801">World Chain Sepolia</option>
                                <option value="7777777">Zora</option>
                            </select>
                        </div>
                        {{#if api_keys}}
                        <div>
                            <label for="api-key-selection">API Key</label>
                            <select id="api-key-selection">
                                {{#each api_keys}}
                                <option value="{{ secret }}">{{ (trunc secret 6) }}...</option>
                                {{/each}}
                            </select>
                        </div>
                        <div><a id="request-query-history" href="">History</a></div>
                        {{/if}}
                        <div><a id="request-query-examples" href="">Examples</a></div>
                    </div>
                    <div class="query-options-right">
                        <div><input type="submit" value="Submit" /></div>
                    </div>
                </div>
            </form>
            <div id="examples">
                <h2>Examples</h2>
                {{#each examples }}
                <div class="query" data-chain="{{chain}}" data-sql="{{sql}}" data-events="{{(join events "\n")}}">
                    <div class="desc">{{ desc }}</div>
                    <div class="event">{{(join events ",")}}</div>
                    <div class="sql">{{ sql }}</div>
                </div>
                {{/each}}
            </div>
            <div id="history">
                <h2>History</h2>
                {{#each history}}
                <div class="query" data-chain="{{chain}}" data-sql="{{sql}}" data-events="{{(join events "\n")}}">
                    <div class="timing">
                        <div class="created_at">{{ created_at }}</div>
                        <div class="latency"><em>{{ latency }}ms</em></div>
                    </div>
                    <div class="event">{{(join events ",")}}</div>
                    <div class="sql">{{ sql }}</div>
                </div>
                {{/each}}
            </div>
            <div id="stats">
                <span>Last Block:</span>
                <span id="block-height"></span>
                <span>Num Rows:</span>
                <span id="num-rows"></span>
            </div>
            <div id="response"></div>
        </main>
    </body>
    <script>
      function querySelected(event) {
        const div = event.target.closest("div.query");
        const chain = div.getAttribute("data-chain");
        const sql = div.getAttribute("data-sql");
        const events = div.getAttribute("data-events");
        setOrAddChain(chain);
        document.getElementById("query").value = sql;
        document.getElementById("events").value = events;

        document
          .querySelectorAll('div.query')
          .forEach((div) => div.classList.remove('highlight'));
        div.classList.add("highlight");
      }

      function showExampleQueries(event) {
        event.preventDefault();
        resetTable();
        hideQueryHistory();
        document.getElementById("examples").style.display = 'block';
        document.querySelector("#examples > div.query").click();
      }

      function hideExampleQueries() {
        document.getElementById("examples").style.display = 'none';
      }

      function clickHistory(event) {
        const url = new URL(window.location.href);
        url.searchParams.set("history", true);
        window.history.replaceState({}, '', url);
      }

      function showHistory() {
        resetTable();
        hideExampleQueries();
        document.getElementById("history").style.display = 'block';
      }

      function hideQueryHistory() {
        document.getElementById("history").style.display = 'none';
      }

        function addHeaderRow(row) {
            const table = document.querySelector("#response table");
            let tr = table.insertRow(0);
            row.forEach((col, i) => {
                const th = document.createElement("th");
                th.textContent = col;
                tr.appendChild(th);
            });
        }

        function addDataRow(rows) {
            let table = document.querySelector("#response table");
            rows.forEach((row) => {
                let tr = document.createElement("tr");
                row.forEach((col, i) => {
                    let td = document.createElement("td");
                    td.textContent = col;
                    tr.appendChild(td);
                });
                if (table.rows.length > 1) {
                    table.insertBefore(tr, table.rows[1]);
                } else {
                    table.appendChild(tr);
                }
                tr.classList.add("highlight");
                setTimeout(() => {
                    tr.classList.remove("highlight");
                }, 500);
            });
            while (table.rows.length > 100) {
                table.deleteRow(-1);
            }
        }

        function printInfo(msg) {
            const response = document.getElementById("response");
            const p = document.createElement("p");
            p.classList.add("info");
            p.textContent = msg;
            response.appendChild(p);
        }

        function printError(msg) {
            const response = document.getElementById("response");
            const p = document.createElement("p");
            p.classList.add("error");
            p.textContent = msg;
            response.appendChild(p);
        }

        function printRateLimit() {
          const p = document.createElement("p");
          p.classList.add("error");
          {{#with user}}
          p.textContent = "Too many requests for this chain. Please upgrade to PRO or check to see if you have selected this chain in your account page.";
          {{ else }}
          p.textContent = "The free plan includes ~5 requests per minute. Log in and select a paid plan for more requests.";
          {{/with}}
          response.appendChild(p);
        }

        function resetTable() {
            document.getElementById("stats").style.display = 'none';
            const response = document.getElementById("response");
            const table = document.createElement("table");
            response.innerHTML = "";
            response.appendChild(table);
        }

        let sseHandler = {};
        let blockHeight = 0;

        function apiKey() {
            const select = document.getElementById("api-key-selection");
            if (select) {
                return select.options[select.selectedIndex].value;
            }
        }

        function apiURL(path, params = new URLSearchParams()) {
            let chain = document.getElementById("chain-selection").value;
            params.set("chain", chain);
            let key = apiKey();
            if (key) {
              params.set("api-key", key);
            }
            return `{{ api_url }}${path}?${params}`;
        }

        function updateStats(height, nrows) {
            document.getElementById("stats").style.display = "block";
            blockHeight = height;
            document.querySelector("#block-height").textContent = height;
            document.querySelector("#num-rows").textContent = nrows;
        }

        function changeLiveQuery(event) {
            closeHandler();
            if (event.target.checked) {
                startHandler();
            }
        }

        function closeHandler() {
            if ("close" in sseHandler) {
                sseHandler.close();
            }
        }

        function startHandler() {
            function liveQueryEnabled() {
                return document.getElementById("live-query").checked;
            }
            if (!liveQueryEnabled()) {
                return;
            }
            console.log(`sse start: ${blockHeight}`);
            sseHandler = new EventSource(
                apiURL("/query-live", form2queryParams()),
            );
            sseHandler.onmessage = function (event) {
                let data = JSON.parse(event.data);
                let newHeight = data["block_height"];
                let result = data["result"][0];
                console.log(`sse latest: ${newHeight}`);
                if (newHeight <= blockHeight) {
                    console.log("sse nothing new");
                    return;
                }
                result.shift(); //remove column names
                addDataRow(result);
                updateStats(newHeight, result.length);
            };
            sseHandler.onerror = function (e) {
                console.log(`sse error: `, e);
            };
        }

        async function submitQuery(event) {
            event.preventDefault();
            hideExampleQueries();
            hideQueryHistory();
            closeHandler();
            form2url();
            const response = await fetch(apiURL("/query"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(form2JSON()),
            });
            if (response.status == 429) {
                resetTable();
                printRateLimit();
            } else if (!response.ok) {
                const { message } = await response.json();
                resetTable();
                printError(message);
            } else {
                const data = await response.json();
                let height = data["block_height"];
                let result = data["result"][0];
                if (result.length > 0) {
                    resetTable();
                    addHeaderRow(result.shift());
                    addDataRow(result.slice(0, 100));
                    updateStats(height, result.length);
                    startHandler();
                } else {
                    resetTable();
                    printInfo("no rows");
                }
            }
        }

        function cmdEnter(event) {
            if (event.keyCode == 13 && event.metaKey) {
                let query = document.getElementById("query");
                query.value = query.value.trim();
                document.getElementById("request").dispatchEvent(
                    new Event("submit", {
                        bubbles: true,
                        cancelable: true,
                    }),
                );
            }
        }

        function jk(event) {
          if (event.key == "ArrowDown" || event.key == "j") {
              const examples = document.querySelectorAll("#examples > div.query");
              const selected = document.querySelector("#examples > div.query.highlight");
              if (selected.nextElementSibling) {
                selected.nextElementSibling.click();
              }
            } else if (event.key = "ArrowUp" || event.key == "k") {
              const examples = document.querySelectorAll("#examples > div.query");
              const selected = document.querySelector("#examples > div.query.highlight");
              if (selected.previousElementSibling) {
                selected.previousElementSibling.click();
              }
            }
        }

        function form2JSON() {
            let query = document.getElementById("query").value;
            let eventSigs = document.getElementById("events").value.split("\n");
            return [{ event_signatures: eventSigs, query: query }];
        }

        function form2queryParams() {
            let params = new URLSearchParams();
            let query = document.getElementById("query").value;
            params.append("query", query);
            let eventSigs = document.getElementById("events").value.split("\n");
            eventSigs.forEach((sig) => {
                params.append("event_signatures", sig.trim());
            });
            let chain = document.getElementById("chain-selection").value;
            params.set("chain", chain);
            params.set("block_height", blockHeight);
            return params;
        }

        function form2url() {
            let url = new URL(window.location.href);
            url.pathname = "query";
            url.search = form2queryParams().toString();
            history.pushState(null, "", url);
            return url.searchParams.toString();
        }

        function setOrAddChain(chain) {
            let select = document.getElementById("chain-selection");
            Array.from(select.options).forEach((opt, i) => {
                if (opt.value === chain) {
                    select.selectedIndex = i;
                    return;
                }
            });
            let opt = document.createElement("option");
            opt.value = chain;
            opt.text = chain;
            select.add(opt);
            select.value = chain;
        }

        function url2form() {
            const params = new URLSearchParams(window.location.search);
            if (params.size == 0) {
              document.querySelector("#examples > div.query").click();
              return;
            }

            let query = params.get("query");
            if (query) {
                document.getElementById("query").value = query;
            }
            let eventSigs = params.getAll("event_signatures");
            if (eventSigs.length > 0) {
                document.getElementById("events").value = eventSigs.join("\n");
            }
            let chain = params.get("chain");
            if (chain) {
                setOrAddChain(chain);
            }
            /*
              When History is clicked, ?history=true is added to the
              url and the page is redirected. As we are loading the page
              if we find a history=true param then we should show the history
              and then remove the param from the URL so that if/when the user
              grabs the URL to share/save the history param is not included.
            */
            let history = params.get("history");
            if (history) {
              showHistory();
              params.delete("history");
              const url = new URL(window.location.href);
              url.search = params;
              window.history.replaceState({}, '', url);
            }
        }

        window.addEventListener("popstate", function (event) {
            url2form();
        });
        window.addEventListener("pushstate", function (event) {
            url2form();
        });

        document.addEventListener("DOMContentLoaded", function () {
            document.addEventListener("keydown", jk);
            document.addEventListener("keydown", cmdEnter);

            document
                .getElementById("request")
                .addEventListener("submit", submitQuery);
            document
                .getElementById("live-query")
                .addEventListener("change", changeLiveQuery);
            document
                .getElementById("request-query-examples")
                .addEventListener("click", showExampleQueries);
            document
                .querySelectorAll("#request-query-history")
                .forEach((div) => div.addEventListener("click", clickHistory));
            document
              .querySelectorAll("div.query")
              .forEach((div) => div.addEventListener("click", querySelected));
            url2form();
        });
    </script>
</html>
