<!doctype html>
    <head>
        <link
            rel="icon"
            href="https://indexsupply.net/ga.ico"
            type="image/x-icon"
        />
        <meta charset="utf-8" />
        <title>Golden Axe Billing</title>
        <style>
        body {
            font-family: Times New Roman;
            max-width: 800px;
        }
        a:link,
        a:visited,
        a:hover,
        a:active {
            color: blue;
            text-decoration: none;
        }
        .navigation {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }
        .navigation .Success {
            color: green;
        }
        .navigation.Warning,
        .navigation.Error {
            color: red;
        }
        #plan {
            width: 100%;
        }
        #menu {
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
            flex-grow: 1;
            gap: 20px;
            margin-bottom: 10px;
        }
        #menu h3 {
            text-align: center;
            border-bottom: 2px solid black;
        }
        .option.current {
            border: 2px dotted black;
        }
        .option.selected {
            border: 2px solid green;
        }
        .option {
            width: 100%;
            box-sizing: border-box;
            border: 2px inset black;
            padding: 0 0 10px 0;
        }
        .option ul {
            padding-inline-start: 20px;
        }
        .option li {
            padding-left: 0px;
        }
        .option .price {
            width: 100%;
            text-align: center;
            font-size: large;
        }
        #change-plan {
            text-align: right;
        }
        #card {
            height: 100%;
            width: 100%;
        }
        #current-card {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }
        #current-card span {
            text-transform: capitalize;
        }
        #new-card {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin: 15px 0 0 0;
        }
        #error {
            color: red;
            text-align: left;
            font-size: 13px;
            line-height: 17px;
            margin-top: 12px;
        }
        #card-element {
            border: 1px solid black;
            width: 40%;
        }
        .hidden {
            visibility: hidden;
        }
        </style>
    </head>
    <body>
        <div class="navigation">
            <div>
                {{#each flash }}
                <marquee class="{{level}}">{{ message }}</marquee>
                {{ else }}
                {{#with user }}
                <marquee>welcome back: {{ email }}</marquee>
                {{/with }}
                {{/each}}
            </div>
            <div>
                {{#with user}}
                <a href="/logout">log out</a>,
                <a href="/">home</a>
                {{else}}
                <a href="/login">log in</a>
                {{/with}}
            </div>
        </div>
        <div id="plan">
            <h2>Plan</h2>
            <div id="menu">
                <div class="option" name="indie">
                    <h3>Indie</h3>
                    <ul>
                        <li>2 Endpoints</li>
                        <li>100 Live Sessions</li>
                        <li>Community Support</li>
                    </ul>
                    <div class="price">$9</div>
                </div>
                <div class="option" name="pro">
                    <h3>Pro</h3>
                    <ul>
                        <li>10 Endpoints</li>
                        <li>1,000 Live Sessions</li>
                        <li>Premium Support</li>
                    </ul>
                    <div class="price">$99</div>
                </div>
                <div class="option" name="extreme">
                    <h3>Extreme</h3>
                    <ul>
                        <li>10 Endpoints</li>
                        <li>10,000 Live Sessions</li>
                        <li>Support with SLA</li>
                    </ul>
                    <div class="price">$499</div>
                </div>
            </div>
            <div id="change-plan">
                <a href="">change plan</a>
            </div>
        </div>
        <div id="card">
            <h2>Payment</h2>
            {{#with payment_method.card }}
            <div id="current-card">
                <span>{{ brand }} {{ last4 }} {{ exp_month }}/{{ exp_year }} </span>
                <a id="show-new-card" href="">new card</a>
            </div>
            {{/with }}
            <div id="new-card" {{#if payment_method.card }} class="hidden" {{/if}}>
                <div id="card-element"><!-- Stripe card Element --></div>
                <a id="submit" href="#">add card</a>
            </div>
            <div id="error" role="alert"></div>
        </div>
    </body>
    <script src="https://js.stripe.com/v3/" defer></script>
    <script defer>
      var disableSubmit = false;
      var addCard = function () {
        if (disableSubmit) {
          return;
        }
        var stripe = Stripe("{{ stripe_pub_key }}");
        var elements = stripe.elements();
          var card = elements.create("card");
          card.mount("#card-element");
          var button = document.getElementById("submit");
          button.addEventListener("click", function (event) {
              event.preventDefault();
              disableSubmit = true;
              stripe
                  .confirmCardSetup("{{ client_secret }}", {
                      payment_method: { card: card },
                  })
                  .then(function (result) {
                      if (result.error) {
                        disableSubmit = false;
                        document.getElementById("error").textContent = result.error.message;
                      } else {
                          stripe
                            .retrieveSetupIntent("{{ client_secret }}")
                            .then(function (result) { disableSubmit = false });
                          location.reload();
                      }
                  });
          });
      };

      function showNewCard(event) {
        event.preventDefault();
        document.getElementById("new-card").classList.remove("hidden");
      };

      function setCurrentPlan(name) {
        let current = document.querySelector(`div.option[name="${name}"]`);
        if (current) {
          current.classList.add("current");
        }
      }

      function changePlan(event) {
        event.preventDefault();
        const newPlan = document.querySelector(".option.selected").getAttribute("name");
        if (confirm(`change to ${newPlan}?`)) {
          fetch("/change-plan", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(newPlan),
          }).then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              response.text().then(msg => {
                document.getElementById("new-card-error").textContent = msg;
              })
            }
          });
        }
      }

      function selectOption(optionDiv, event) {
        document.querySelectorAll(".option").forEach(div => {
          div.classList.remove('selected');
        });
        optionDiv.classList.add('selected');
      };

      document.addEventListener("DOMContentLoaded", () => {
        addCard();
        setCurrentPlan("{{ plan }}");

        document
          .getElementById("show-new-card")
          .addEventListener("click", showNewCard);

        document
          .getElementById("change-plan")
          .addEventListener("click", changePlan);

        document.querySelectorAll(".option").forEach(div => {
          div.addEventListener("click", (event) => {
            selectOption(div, event);
          })
        });
      });
    </script>
</html>
